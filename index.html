<!doctype html>
<html>
	<head>
		<script src="https://cdn.jsdelivr.net/pyodide/v0.26.0/full/pyodide.js"></script>
	</head>

	<body>
		<img src="/assets/logo.webp" width=100%>
		<br />
		<label for="directory-picker">1. Select a activity/analytics directory</label>
		<button id="directory-picker" onclick="evaluatePython()" disabled>Pick Directory</button>
		<br />
		<br />
		<label for="runbutton">2. push this button</label>
		<button id="runbutton" disabled>CRUNCH THE DATA</button>
		<br />
		<!-- <button onclick="evaluatePython()"">Eval python again?</button> -->
		<!-- <p>Program output:</p> -->
		<!-- <div style="border:2px inset #AAA;cursor:text;height:120px;overflow:auto;width:600px; resize:both"> -->
		<!-- 	<div id="content"> </div> -->
		<!-- </div> -->
		<div>JS output</div>
		<textarea id="output" style="width: 100%;" rows="8" disabled></textarea>
		<div>Python output</div>
		<textarea id="output2" style="width: 100%;" rows="8" disabled></textarea>

		<script>
			const output = document.getElementById("output");
			function addToOutput(s) {
				output.value += s + "\n";
			}

			addToOutput("Loading python packages... ðŸ”§");
			// init Pyodide
			async function main() {
				var out2 = document.getElementById("output2")
				let pyodide = await loadPyodide({
					stdout: (text) => {out2.textContent += text + "\n";},
					stderr: (text) => {out2.textContent += text + "\n";}
				});
				await pyodide.loadPackage("micropip");
				const micropip = pyodide.pyimport("micropip");
				await micropip.install("matplotlib");
				// await micropip.install("pandas");
				addToOutput("Python packages and runtime loaded! âœ…");
				document.getElementById("directory-picker").removeAttribute("disabled")
				return pyodide;
			}
			let pyodideReadyPromise = main();


			async function evaluatePython() {
				let pyodide = await pyodideReadyPromise;
				try {
					const dirHandle = await showDirectoryPicker();
					const permissionStatus = await dirHandle.requestPermission({
						mode: "read",
					});

					if (permissionStatus !== "granted") {
						throw new Error("read access to directory not granted");
					}

					const nativefs = await pyodide.mountNativeFS("/data", dirHandle);
					addToOutput("Loading python script... ðŸ”§");
					pyodide.runPython(await (await fetch("/script.py")).text())
					addToOutput("Python file loaded! âœ…");
					document.getElementById("runbutton").removeAttribute("disabled")

				} catch (err) {
					addToOutput(err);
				}
			}

		</script>
	</body>
</html>
